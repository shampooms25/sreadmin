{% extends "admin/base_site.html" %}
{% load static %}
{% load starlink_extras %}

{% block title %}{{ title }}{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
.a{% block content %}
<div class="api-status-container">
    <nav class="breadcrumb">
        {% for crumb in breadcrumbs %}
            {% if crumb.url %}
                <a href="{{ crumb.url }}">{{ crumb.name }}</a> /
            {% else %}
                <span>{{ crumb.name }}</span>
            {% endif %}
        {% endfor %}
    </nav>

    <!-- Account Selector -->
    <div class="account-selector-container">
        <div class="account-selector">
            <label for="account-select">Selecionar Conta:</label>
            <select id="account-select" onchange="changeAccount(this.value)">
                <option value="">Todas as Contas</option>
                {% for account_id, account_name in available_accounts.items %}
                    <option value="{{ account_id }}" {% if account_id == selected_account %}selected{% endif %}>
                        {{ account_name }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="header-section">
        <h1><i class="fas fa-server"></i> {{ title }}</h1>
        <p>Status da conectividade com a API Starlink
        {% if selected_account %}
            - <strong>{{ available_accounts|get_item:selected_account }}</strong>
        {% endif %}
        </p>
    </div>ner {
    padding: 20px;
}

.breadcrumb {
    background: #f8f9fa;
    padding: 10px 15px;
    border-radius: 5px;
    margin-bottom: 20px;
}

.breadcrumb a {
    color: #007cba;
    text-decoration: none;
}

.breadcrumb a:hover {
    text-decoration: underline;
}

.header-section {
    background: linear-gradient(135deg, #fd7e14 0%, #dc3545 100%);
    color: white;
    padding: 25px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.status-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 30px;
    text-align: center;
    margin-bottom: 20px;
}

.status-icon {
    font-size: 4em;
    margin-bottom: 20px;
}

.status-icon.success {
    color: #28a745;
}

.status-icon.error {
    color: #dc3545;
}

.status-icon.loading {
    color: #007cba;
.test-button:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
}

/* Account Selector Styles */
.account-selector-container {
    margin-bottom: 20px;
}

.account-selector {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 10px;
}

.account-selector label {
    font-weight: bold;
    color: #333;
    margin: 0;
}

.account-selector select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
    color: #333;
    font-size: 14px;
    min-width: 200px;
}

.account-selector select:focus {
    border-color: #007cba;
    outline: none;
    box-shadow: 0 0 0 2px rgba(0, 124, 186, 0.2);
}   0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.status-message {
    font-size: 1.3em;
    margin-bottom: 15px;
}

.status-details {
    color: #666;
    margin-bottom: 25px;
}

.test-button {
    background: #007cba;
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 8px;
    font-size: 1.1em;
    cursor: pointer;
    transition: all 0.3s ease;
}

.test-button:hover {
    background: #005a87;
    transform: translateY(-2px);
}

.test-button:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
}

.api-info {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 15px;
}

.info-item {
    background: white;
    padding: 15px;
    border-radius: 5px;
    border-left: 4px solid #007cba;
}

.info-label {
    font-weight: bold;
    color: #333;
    margin-bottom: 5px;
}

.info-value {
    color: #666;
    font-family: monospace;
    word-break: break-all;
}

.action-buttons {
    margin-bottom: 20px;
}

.btn {
    padding: 10px 20px;
    border-radius: 5px;
    text-decoration: none;
    display: inline-block;
    margin-right: 10px;
    border: none;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn:hover {
    text-decoration: none;
    opacity: 0.9;
}
</style>
{% endblock %}

{% block content %}
<div class="api-status-container">
    <nav class="breadcrumb">
        {% for crumb in breadcrumbs %}
            {% if crumb.url %}
                <a href="{{ crumb.url }}">{{ crumb.name }}</a> /
            {% else %}
                <span>{{ crumb.name }}</span>
            {% endif %}
        {% endfor %}
    </nav>

    <div class="header-section">
        <h1><i class="fas fa-heartbeat"></i> {{ title }}</h1>
        <p>Verificação de conectividade e funcionamento da API Starlink</p>
    </div>

    <div class="action-buttons">
        <a href="{% url 'painel:starlink_dashboard' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar ao Dashboard
        </a>
    </div>

    <div class="status-card">
        <div id="status-icon" class="status-icon {% if api_status.status == 'success' %}success{% elif api_status.status == 'error' %}error{% endif %}">
            {% if api_status.status == 'success' %}
                <i class="fas fa-check-circle"></i>
            {% elif api_status.status == 'error' %}
                <i class="fas fa-times-circle"></i>
            {% else %}
                <i class="fas fa-question-circle"></i>
            {% endif %}
        </div>
        <div id="status-message" class="status-message">
            {% if api_status.message %}
                {{ api_status.message }}
            {% else %}
                Clique no botão abaixo para testar a conexão com a API
            {% endif %}
        </div>
        <div id="status-details" class="status-details">
            {% if api_status.details %}
                {{ api_status.details }}
                {% if api_status.timestamp %}
                    <br><small>Verificado em: {{ api_status.timestamp }}</small>
                {% endif %}
            {% else %}
                O teste verificará a autenticação e a capacidade de consultar dados da API Starlink
            {% endif %}
        </div>
        <button id="test-btn" class="test-button" onclick="testApiConnection()">
            <i class="fas fa-sync"></i> {% if api_status.status %}Testar Novamente{% else %}Testar Conexão{% endif %}
        </button>
    </div>

    <div class="api-info">
        <h3><i class="fas fa-info-circle"></i> Informações da API</h3>
    });
}

function changeAccount(accountId) {
    const currentUrl = new URL(window.location.href);
    if (accountId) {
        currentUrl.searchParams.set('account', accountId);
    } else {
        currentUrl.searchParams.delete('account');
    }
    window.location.href = currentUrl.toString();
}
</script>
{% endblock %}  <div class="info-value">https://api.starlink.com/auth/connect/token</div>
            </div>
            <div class="info-item">
                <div class="info-label">Endpoint de Consulta:</div>
                <div class="info-value">https://web-api.starlink.com/enterprise/v1/accounts/ACC-2744134-64041-5/billing-cycles/query</div>
            </div>
            <div class="info-item">
                <div class="info-label">Account ID:</div>
                <div class="info-value">ACC-2744134-64041-5</div>
            </div>
            <div class="info-item">
                <div class="info-label">Client ID:</div>
                <div class="info-value">498ca080-3eb2-4a4d-a5d9-3828dbef0194</div>
            </div>
        </div>
    </div>
</div>

<script>
function testApiConnection() {
    const statusIcon = document.getElementById('status-icon');
    const statusMessage = document.getElementById('status-message');
    const statusDetails = document.getElementById('status-details');
    const testBtn = document.getElementById('test-btn');
    
    // Estado de carregamento
    statusIcon.innerHTML = '<i class="fas fa-spinner"></i>';
    statusIcon.className = 'status-icon loading';
    statusMessage.textContent = 'Testando conexão...';
    statusDetails.textContent = 'Aguarde enquanto verificamos a conectividade com a API Starlink';
    testBtn.disabled = true;
    testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testando...';
    
    // Fazer requisição AJAX
    fetch('{% url "painel:starlink_api_status" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Sucesso
            statusIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
            statusIcon.className = 'status-icon success';
            statusMessage.textContent = 'API funcionando corretamente!';
            statusDetails.textContent = `${data.message} - ${data.service_lines_count} Service Lines encontrados`;
        } else {
            // Erro
            statusIcon.innerHTML = '<i class="fas fa-times-circle"></i>';
            statusIcon.className = 'status-icon error';
            statusMessage.textContent = 'Erro na conexão com a API';
            statusDetails.textContent = data.message;
        }
    })
    .catch(error => {
        // Erro de rede
        statusIcon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
        statusIcon.className = 'status-icon error';
        statusMessage.textContent = 'Erro de rede';
        statusDetails.textContent = 'Não foi possível conectar ao servidor. Verifique sua conexão.';
    })
    .finally(() => {
        // Reabilitar botão
        testBtn.disabled = false;
        testBtn.innerHTML = '<i class="fas fa-redo"></i> Testar Novamente';
    });
}
</script>
{% endblock %}
