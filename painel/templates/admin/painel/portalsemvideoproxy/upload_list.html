{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_list %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrahead %}
    <link rel="stylesheet" type="text/css" href="{% static 'admin/css/image_preview.css' %}?v={{ timestamp }}">
    <style>
        /* CSS inline para garantir que funcione */
        .portal-ativo-destaque {
            padding: 15px;
            background-color: #f8f9fa;
            border: 2px solid #007bff;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .portal-ativo-destaque label {
            font-weight: bold;
            font-size: 1.2em;
            color: #007bff;
        }
        .file-size-info {
            margin-top: 10px;
            padding: 8px;
            background-color: #e3f2fd;
            border-radius: 4px;
            border-left: 4px solid #2196f3;
        }
        .image-preview-widget .current-image img,
        .image-preview-widget .new-image-preview img {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
    </style>
{% endblock %}

{% block branding %}
<h1 id="site-name"><a href="{% url 'admin:index' %}">{{ site_header|default:_('Django administration') }}</a></h1>
{% endblock %}

{% block nav-global %}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">{{ title }}</h3>
                </div>
                <div class="card-body">
                    <!-- CAMPO PORTAL ATIVO NA PRIMEIRA LINHA -->
                    <div style="background: linear-gradient(90deg, #007bff, #0056b3); color: white; padding: 20px; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 4px 8px rgba(0,123,255,0.3);">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            {{ form.ativo }}
                            <label for="{{ form.ativo.id_for_label }}" style="font-weight: bold; font-size: 1.3em; margin: 0; cursor: pointer;">
                                üî• {{ form.ativo.label }}
                            </label>
                        </div>
                        {% if form.ativo.help_text %}
                            <small style="display: block; margin-top: 8px; opacity: 0.9;">{{ form.ativo.help_text }}</small>
                        {% endif %}
                    </div>

                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label for="{{ form.nome.id_for_label }}">{{ form.nome.label }}</label>
                                    {{ form.nome }}
                                    {% if form.nome.help_text %}
                                        <small class="form-text text-muted">{{ form.nome.help_text }}</small>
                                    {% endif %}
                                </div>

                                <div class="form-group">
                                    <label for="{{ form.versao.id_for_label }}">{{ form.versao.label }}</label>
                                    {{ form.versao }}
                                    {% if form.versao.help_text %}
                                        <small class="form-text text-muted">{{ form.versao.help_text }}</small>
                                    {% endif %}
                                </div>

                                <div class="form-group">
                                    <label for="{{ form.descricao.id_for_label }}">{{ form.descricao.label }}</label>
                                    {{ form.descricao }}
                                    {% if form.descricao.help_text %}
                                        <small class="form-text text-muted">{{ form.descricao.help_text }}</small>
                                    {% endif %}
                                </div>

                                <div class="form-group">
                                    <label for="{{ form.arquivo_zip.id_for_label }}">{{ form.arquivo_zip.label }}</label>
                                    {{ form.arquivo_zip }}
                                    {% if form.arquivo_zip.help_text %}
                                        <small class="form-text text-muted">{{ form.arquivo_zip.help_text }}</small>
                                    {% endif %}
                                    
                                    <!-- TAMANHO DO ARQUIVO LOGO ABAIXO -->
                                    <div style="margin-top: 15px; padding: 12px; background: linear-gradient(90deg, #28a745, #20c997); color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(40,167,69,0.3);">
                                        <strong style="font-size: 1.1em;">üìè Tamanho (MB):</strong> 
                                        <span id="file-size-display" style="font-weight: bold;">Nenhum arquivo selecionado</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.preview.id_for_label }}">{{ form.preview.label }}</label>
                                    {{ form.preview }}
                                    {% if form.preview.help_text %}
                                        <small class="form-text text-muted">{{ form.preview.help_text }}</small>
                                    {% endif %}
                                </div>
                                
                                <div class="alert alert-info">
                                    <h6>üí° Dicas:</h6>
                                    <ul style="margin-bottom: 0; padding-left: 20px;">
                                        <li>Use imagens PNG, JPG ou JPEG</li>
                                        <li>A imagem ser√° redimensionada automaticamente</li>
                                        <li>Tamanho recomendado: 800x600px</li>
                                        <li>O arquivo ZIP ser√° automaticamente medido</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group mt-3">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save"></i> Salvar Portal
                            </button>
                            <a href="../" class="btn btn-secondary btn-lg">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {% if portais %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Portais Cadastrados</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Vers√£o</th>
                                    <th>Status</th>
                                    <th>Tamanho</th>
                                    <th>Preview</th>
                                    <th>Data</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for portal in portais %}
                                <tr>
                                    <td>{{ portal.nome }}</td>
                                    <td>{{ portal.versao }}</td>
                                    <td>
                                        {% if portal.ativo %}
                                            <span class="badge badge-success">‚úÖ Ativo</span>
                                        {% else %}
                                            <span class="badge badge-secondary">‚ö™ Inativo</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ portal.tamanho_mb }}MB</td>
                                    <td>
                                        {% if portal.preview %}
                                            <img src="{{ portal.preview.url }}" style="max-width: 60px; max-height: 40px;" class="img-thumbnail" />
                                        {% else %}
                                            ‚Äî
                                        {% endif %}
                                    </td>
                                    <td>{{ portal.data_atualizacao|date:"d/m/Y H:i" }}</td>
                                    <td>
                                        <a href="../{{ portal.id }}/change/" class="btn btn-sm btn-primary">
                                            <i class="fas fa-edit"></i> Editar
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.form-group {
    margin-bottom: 1rem;
}
.form-group label {
    font-weight: bold;
    display: block;
    margin-bottom: 0.5rem;
}
.form-control, .form-control-file {
    width: 100%;
    padding: 0.375rem 0.75rem;
    margin-bottom: 0.5rem;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Fun√ß√£o para formatar bytes em MB
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 MB';
        const mb = bytes / (1024 * 1024);
        return mb.toFixed(2) + ' MB';
    }
    
    // Debug para o input de preview
    const previewInput = document.querySelector('input[name="preview"]');
    if (previewInput) {
        previewInput.addEventListener('change', function(e) {
            console.log('Preview file selected:', e.target.files[0]);
            if (e.target.files[0]) {
                console.log('File name:', e.target.files[0].name);
                console.log('File size:', e.target.files[0].size);
                console.log('File type:', e.target.files[0].type);
            }
        });
    }
    
    // Monitorar mudan√ßas no arquivo ZIP e atualizar o tamanho
    const zipInput = document.querySelector('input[name="arquivo_zip"]');
    const fileSizeDisplay = document.getElementById('file-size-display');
    
    if (zipInput && fileSizeDisplay) {
        zipInput.addEventListener('change', function(e) {
            console.log('ZIP file input changed:', e.target.files);
            
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                const fileSize = formatFileSize(file.size);
                const fileName = file.name;
                
                console.log('ZIP file details:', {
                    name: fileName,
                    size: file.size,
                    sizeFormatted: fileSize,
                    type: file.type
                });
                
                // Atualizar o display do tamanho
                fileSizeDisplay.innerHTML = `<strong>${fileSize}</strong> (${fileName})`;
                fileSizeDisplay.style.color = '#28a745';
                
                // Validar se √© um arquivo ZIP
                if (!fileName.toLowerCase().endsWith('.zip')) {
                    fileSizeDisplay.innerHTML += '<br><span style="color: #dc3545;">‚ö†Ô∏è Aten√ß√£o: O arquivo deve ter extens√£o .zip</span>';
                }
            } else {
                fileSizeDisplay.textContent = 'Nenhum arquivo selecionado';
                fileSizeDisplay.style.color = '#6c757d';
            }
        });
    }
    
    // Debug para todos os inputs de arquivo
    const fileInputs = document.querySelectorAll('input[type="file"]');
    fileInputs.forEach(input => {
        input.addEventListener('change', function(e) {
            console.log('File input changed:', input.name, e.target.files);
        });
    });
});
</script>
{% endblock %}
